# üöÄ Guia de Deploy - WiizoChat v2

Guia completo para fazer deploy do WiizoChat v2 em produ√ß√£o.

## üìã √çndice

- [Vis√£o Geral](#-vis√£o-geral)
- [Pr√©-requisitos](#-pr√©-requisitos)
- [Deploy do Frontend (Vercel)](#-deploy-do-frontend-vercel)
- [Deploy do Backend (Supabase)](#-deploy-do-backend-supabase)
- [Configura√ß√£o de Dom√≠nio](#-configura√ß√£o-de-dom√≠nio)
- [Configura√ß√£o de SSL](#-configura√ß√£o-de-ssl)
- [Monitoramento](#-monitoramento)
- [Troubleshooting](#-troubleshooting)

---

## üéØ Vis√£o Geral

O WiizoChat v2 utiliza uma arquitetura moderna com:

- **Frontend:** Vercel (React + Vite)
- **Backend:** Supabase (PostgreSQL + Edge Functions)
- **CDN:** Vercel Edge Network
- **SSL:** Autom√°tico via Vercel e Supabase

### **Arquitetura de Deploy**

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Frontend      ‚îÇ    ‚îÇ   Backend       ‚îÇ    ‚îÇ   External      ‚îÇ
‚îÇ   (Vercel)      ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ   (Supabase)    ‚îÇ‚óÑ‚îÄ‚îÄ‚ñ∫‚îÇ   APIs          ‚îÇ
‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ    ‚îÇ                 ‚îÇ
‚îÇ ‚Ä¢ React App     ‚îÇ    ‚îÇ ‚Ä¢ PostgreSQL    ‚îÇ    ‚îÇ ‚Ä¢ OpenAI        ‚îÇ
‚îÇ ‚Ä¢ Static Files  ‚îÇ    ‚îÇ ‚Ä¢ Edge Functions‚îÇ    ‚îÇ ‚Ä¢ WhatsApp      ‚îÇ
‚îÇ ‚Ä¢ CDN           ‚îÇ    ‚îÇ ‚Ä¢ Auth          ‚îÇ    ‚îÇ ‚Ä¢ Instagram     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîß Pr√©-requisitos

### **Contas Necess√°rias**
- [Vercel](https://vercel.com) - Deploy frontend
- [Supabase](https://supabase.com) - Backend e banco
- [GitHub](https://github.com) - Reposit√≥rio de c√≥digo

### **Ferramentas**
```bash
# Vercel CLI
npm install -g vercel

# Supabase CLI
npm install -g supabase

# Git (j√° deve estar instalado)
git --version
```

### **Configura√ß√µes Iniciais**
```bash
# Login no Vercel
vercel login

# Login no Supabase
supabase login
```

---

## üåê Deploy do Frontend (Vercel)

### **1. Prepara√ß√£o do Projeto**

#### **Configurar package.json**
```json
{
  "name": "wiizochat-v2",
  "version": "2.0.0",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview",
    "vercel-build": "npm run build"
  },
  "engines": {
    "node": ">=18.0.0"
  }
}
```

#### **Configurar vercel.json**
```json
{
  "version": 2,
  "builds": [
    {
      "src": "package.json",
      "use": "@vercel/static-build",
      "config": {
        "distDir": "dist"
      }
    }
  ],
  "routes": [
    {
      "src": "/(.*)",
      "dest": "/index.html"
    }
  ],
  "env": {
    "VITE_SUPABASE_URL": "@supabase-url",
    "VITE_SUPABASE_ANON_KEY": "@supabase-anon-key"
  }
}
```

### **2. Deploy via CLI**

#### **Deploy Inicial**
```bash
# No diret√≥rio do projeto
vercel

# Seguir as instru√ß√µes:
# ? Set up and deploy "~/wiizochat-v2"? [Y/n] y
# ? Which scope do you want to deploy to? [Seu usu√°rio]
# ? Link to existing project? [N] n
# ? What's your project's name? wiizochat-v2
# ? In which directory is your code located? ./
```

#### **Deploy de Produ√ß√£o**
```bash
# Deploy para produ√ß√£o
vercel --prod

# Ou usar alias
vercel -p
```

### **3. Deploy via GitHub**

#### **Conectar Reposit√≥rio**
1. Acesse [vercel.com/dashboard](https://vercel.com/dashboard)
2. Clique em "New Project"
3. Importe do GitHub
4. Selecione o reposit√≥rio `wiizochat-v2`
5. Configure as vari√°veis de ambiente
6. Clique em "Deploy"

#### **Configurar Auto-Deploy**
```yaml
# .github/workflows/deploy.yml
name: Deploy to Vercel

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm ci
      - run: npm run build
      - uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
          working-directory: ./
```

### **4. Configurar Vari√°veis de Ambiente**

#### **Via Dashboard Vercel**
1. Acesse o projeto no dashboard
2. V√° em Settings > Environment Variables
3. Adicione as vari√°veis:

```env
VITE_SUPABASE_URL=https://seu-projeto.supabase.co
VITE_SUPABASE_ANON_KEY=sua-chave-anonima
VITE_OPENAI_API_KEY=sk-sua-chave-openai
VITE_WHATSAPP_ACCESS_TOKEN=seu-token-whatsapp
VITE_WHATSAPP_PHONE_ID=seu-phone-id
VITE_INSTAGRAM_ACCESS_TOKEN=seu-token-instagram
VITE_GOOGLE_CLIENT_ID=seu-client-id
VITE_FACEBOOK_ACCESS_TOKEN=seu-token-facebook
```

#### **Via CLI**
```bash
# Adicionar vari√°vel
vercel env add VITE_SUPABASE_URL

# Listar vari√°veis
vercel env ls

# Remover vari√°vel
vercel env rm VITE_SUPABASE_URL
```

### **5. Configurar Dom√≠nio Customizado**

#### **Adicionar Dom√≠nio**
```bash
# Adicionar dom√≠nio
vercel domains add wiizochat.com

# Verificar status
vercel domains ls
```

#### **Configurar DNS**
```
# Registro A
@ 76.76.19.61

# Registro CNAME
www cname.vercel-dns.com
```

---

## üóÑÔ∏è Deploy do Backend (Supabase)

### **1. Configurar Projeto**

#### **Criar Projeto**
```bash
# Via CLI
supabase projects create wiizochat-v2 --region us-east-1

# Ou via dashboard
# https://supabase.com/dashboard
```

#### **Link com Projeto Local**
```bash
# Link com projeto existente
supabase link --project-ref seu-project-ref

# Verificar status
supabase status
```

### **2. Deploy das Migra√ß√µes**

#### **Executar Migra√ß√µes**
```bash
# Aplicar todas as migra√ß√µes
supabase db push

# Verificar status
supabase db diff

# Reset do banco (se necess√°rio)
supabase db reset
```

#### **Estrutura de Migra√ß√µes**
```
supabase/migrations/
‚îú‚îÄ‚îÄ 20240115000001_create_users_table.sql
‚îú‚îÄ‚îÄ 20240115000002_create_companies_table.sql
‚îú‚îÄ‚îÄ 20240115000003_create_leads_table.sql
‚îú‚îÄ‚îÄ 20240115000004_create_conversations_table.sql
‚îî‚îÄ‚îÄ 20240115000005_create_workflows_table.sql
```

### **3. Deploy das Edge Functions**

#### **Estrutura das Functions**
```
supabase/functions/
‚îú‚îÄ‚îÄ openai-proxy/
‚îÇ   ‚îú‚îÄ‚îÄ index.ts
‚îÇ   ‚îî‚îÄ‚îÄ deno.json
‚îú‚îÄ‚îÄ whatsapp-api/
‚îÇ   ‚îú‚îÄ‚îÄ index.ts
‚îÇ   ‚îî‚îÄ‚îÄ deno.json
‚îî‚îÄ‚îÄ webhooks/
    ‚îú‚îÄ‚îÄ index.ts
    ‚îî‚îÄ‚îÄ deno.json
```

#### **Deploy Individual**
```bash
# Deploy de uma function espec√≠fica
supabase functions deploy openai-proxy

# Deploy de todas as functions
supabase functions deploy

# Verificar functions
supabase functions list
```

#### **Exemplo de Edge Function**
```typescript
// supabase/functions/openai-proxy/index.ts
import { serve } from "https://deno.land/std@0.168.0/http/server.ts"
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    const { messages, model, temperature } = await req.json()
    
    // Implementa√ß√£o da proxy para OpenAI
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${Deno.env.get('OPENAI_API_KEY')}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: model || 'gpt-4.1-2025-04-14',
        messages,
        temperature: temperature || 0.7,
      }),
    })

    const data = await response.json()

    return new Response(JSON.stringify(data), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      status: 200,
    })
  } catch (error) {
    return new Response(JSON.stringify({ error: error.message }), {
      headers: { ...corsHeaders, 'Content-Type': 'application/json' },
      status: 500,
    })
  }
})
```

### **4. Configurar Pol√≠ticas RLS**

#### **Exemplo de Pol√≠tica**
```sql
-- Habilitar RLS
ALTER TABLE leads ENABLE ROW LEVEL SECURITY;

-- Pol√≠tica para usu√°rios autenticados
CREATE POLICY "Users can view their own leads" ON leads
  FOR SELECT USING (auth.uid() = user_id);

-- Pol√≠tica para inser√ß√£o
CREATE POLICY "Users can insert their own leads" ON leads
  FOR INSERT WITH CHECK (auth.uid() = user_id);

-- Pol√≠tica para atualiza√ß√£o
CREATE POLICY "Users can update their own leads" ON leads
  FOR UPDATE USING (auth.uid() = user_id);
```

### **5. Configurar Storage**

#### **Criar Buckets**
```bash
# Criar buckets necess√°rios
supabase storage create-bucket avatars
supabase storage create-bucket documents
supabase storage create-bucket campaigns
```

#### **Configurar Pol√≠ticas de Storage**
```sql
-- Pol√≠tica para avatars
CREATE POLICY "Public Access" ON storage.objects
  FOR SELECT USING (bucket_id = 'avatars');

-- Pol√≠tica para documentos
CREATE POLICY "Authenticated Access" ON storage.objects
  FOR ALL USING (auth.role() = 'authenticated' AND bucket_id = 'documents');
```

---

## üåç Configura√ß√£o de Dom√≠nio

### **1. Configurar DNS**

#### **Registros DNS Necess√°rios**
```
# Dom√≠nio principal
@ A 76.76.19.61

# Subdom√≠nio para API
api CNAME cname.vercel-dns.com

# Subdom√≠nio para webhooks
webhooks CNAME cname.vercel-dns.com

# Subdom√≠nio para admin
admin CNAME cname.vercel-dns.com
```

### **2. Configurar Subdom√≠nios**

#### **Via Vercel Dashboard**
1. Acesse o projeto
2. V√° em Settings > Domains
3. Adicione subdom√≠nios:
   - `api.wiizochat.com`
   - `webhooks.wiizochat.com`
   - `admin.wiizochat.com`

#### **Via CLI**
```bash
# Adicionar subdom√≠nio
vercel domains add api.wiizochat.com
vercel domains add webhooks.wiizochat.com
vercel domains add admin.wiizochat.com
```

### **3. Configurar Supabase**

#### **Adicionar Dom√≠nios Permitidos**
1. Acesse Supabase Dashboard
2. V√° em Settings > API
3. Adicione em "Site URL":
   - `https://wiizochat.com`
   - `https://api.wiizochat.com`
   - `https://admin.wiizochat.com`

#### **Configurar CORS**
```sql
-- Adicionar dom√≠nios permitidos
UPDATE auth.config 
SET site_url = 'https://wiizochat.com',
    additional_redirect_urls = '["https://api.wiizochat.com", "https://admin.wiizochat.com"]';
```

---

## üîí Configura√ß√£o de SSL

### **1. SSL Autom√°tico**

#### **Vercel**
- SSL √© configurado automaticamente
- Certificados Let's Encrypt
- Renova√ß√£o autom√°tica

#### **Supabase**
- SSL habilitado por padr√£o
- Certificados gerenciados automaticamente

### **2. Verificar SSL**

#### **Testar Certificados**
```bash
# Verificar certificado principal
openssl s_client -connect wiizochat.com:443 -servername wiizochat.com

# Verificar subdom√≠nios
openssl s_client -connect api.wiizochat.com:443 -servername api.wiizochat.com
```

#### **Ferramentas Online**
- [SSL Labs](https://www.ssllabs.com/ssltest/)
- [SSL Checker](https://www.sslchecker.com/)

---

## üìä Monitoramento

### **1. Vercel Analytics**

#### **Habilitar Analytics**
1. Acesse o projeto no Vercel
2. V√° em Analytics
3. Habilite "Web Analytics"

#### **M√©tricas Dispon√≠veis**
- Page Views
- Unique Visitors
- Bounce Rate
- Core Web Vitals

### **2. Supabase Monitoring**

#### **Dashboard de M√©tricas**
1. Acesse Supabase Dashboard
2. V√° em Reports
3. Visualize m√©tricas:
   - Database Performance
   - API Usage
   - Storage Usage
   - Auth Metrics

#### **Logs e Debugging**
```bash
# Ver logs gerais
supabase logs

# Ver logs de uma function espec√≠fica
supabase functions logs openai-proxy --follow

# Ver logs de erro
supabase logs --level error
```

### **3. Monitoramento Customizado**

#### **Health Check Endpoint**
```typescript
// pages/api/health.ts
export default function handler(req, res) {
  const health = {
    status: 'ok',
    timestamp: new Date().toISOString(),
    services: {
      database: 'connected',
      openai: 'connected',
      whatsapp: 'connected'
    }
  }
  
  res.status(200).json(health)
}
```

#### **Uptime Monitoring**
- [UptimeRobot](https://uptimerobot.com/)
- [Pingdom](https://www.pingdom.com/)
- [StatusCake](https://www.statuscake.com/)

---

## üîß Troubleshooting

### **Problemas Comuns**

#### **1. Erro de Build no Vercel**
```bash
# Verificar logs de build
vercel logs

# Build local para testar
npm run build

# Verificar vari√°veis de ambiente
vercel env ls
```

#### **2. Erro de Conex√£o Supabase**
```bash
# Verificar status
supabase status

# Verificar logs
supabase logs --level error

# Testar conex√£o
supabase db ping
```

#### **3. Erro de CORS**
```typescript
// Configurar CORS nas Edge Functions
const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
  'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
}
```

#### **4. Erro de Rate Limit**
```bash
# Verificar limites
vercel limits

# Verificar uso de API
supabase projects list
```

### **Comandos de Diagn√≥stico**

```bash
# Status geral do projeto
vercel status

# Verificar dom√≠nios
vercel domains ls

# Verificar deployments
vercel ls

# Verificar logs
vercel logs --follow

# Status do Supabase
supabase status

# Verificar functions
supabase functions list

# Verificar migra√ß√µes
supabase db diff
```

### **Logs Importantes**

#### **Vercel**
- Build logs: Dashboard > Deployments > [Deploy] > Build Logs
- Function logs: Dashboard > Functions > [Function] > Logs
- Edge logs: Dashboard > Edge Functions > Logs

#### **Supabase**
- Database logs: Dashboard > Logs > Database
- Auth logs: Dashboard > Logs > Auth
- Edge Function logs: Dashboard > Edge Functions > [Function] > Logs

---

## üìö Pr√≥ximos Passos

Ap√≥s o deploy:

1. **Configure monitoramento** cont√≠nuo
2. **Implemente backup** autom√°tico
3. **Configure alertas** para problemas
4. **Documente** o processo de deploy
5. **Treine** a equipe no processo

---

## üÜò Suporte

- **Email:** deploy@wiizochat.com
- **Discord:** [Servidor WiizoChat](https://discord.gg/wiizochat)
- **Documenta√ß√£o:** [docs.wiizochat.com](https://docs.wiizochat.com)

---

**√öltima atualiza√ß√£o:** Janeiro 2024
